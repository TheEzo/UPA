{% from 'graph_tab.html' import graph_tab %}

<!DOCTYPE html>
<html lang="en">

<head>
  <style>
    .okres {
      fill: white;
      stroke: black;
      stroke-width: 1;
    }

    #tooltip {
      background: cornsilk;
      border: 1px solid black;
      border-radius: 5px;
      padding: 5px;
    }
  </style>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>UPA - projekt</title>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
    integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

  <link href="{{ url_for('static', filename='css/nouislider.css') }}" rel="stylesheet">
</head>

<body>

  <div class="container">
    <div class="row">
      <div class="col-lg-12 text-center">
        <h1>UPA - projekt</h1>
      </div>
      <div class="col-lg-4">
        <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
          <a class="nav-link active" id="v-pills-query-A-tab" data-toggle="pill" href="#v-pills-query-A" role="tab"
            aria-controls="v-pills-query-A" aria-selected="true">Výsledky dotazu A</a>

          <a class="nav-link" id="v-pills-query-B-tab" data-toggle="pill" href="#v-pills-query-B" role="tab"
            aria-controls="v-pills-query-B" aria-selected="false">Výsledky dotazu B</a>

          <a class="nav-link" id="v-pills-query-C-tab" data-toggle="pill" href="#v-pills-query-C" role="tab"
            aria-controls="v-pills-query-C" aria-selected="false">Výsledky vlastního dotazu</a>
        </div>
      </div>
      <div class="col-lg-4">
        <h5>Řešitelé:</h5>
        <ul>
          <li>Kapoun Petr - xkapou04</li>
          <li>Nováček pavel - xnovac16</li>
          <li>Willaschek Tomáš - xwilla00</li>
        </ul>
      </div>
      <div class="col-lg-4" style="display: flex; flex-wrap: wrap; align-items: flex-start; justify-content: center;"> 
        <div style="min-height: 50%; max-height: 50%; min-width: 100%;">
          <button id="erase-button" type="submit" class="btn btn-danger" style="float: inline-end;" onclick="javascript: erase();">Nahrát nová data</button>
        </div>

        <div class="mt-5" style="min-height: 50%; max-height: 50%; min-width: 100%; text-align: center;">
          <div id="slider-snap"></div>
          <button id="filter-button" type="submit" class="btn btn-primary mt-1" onclick="javascript: filterDateRange();">Filtrovat</button>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="tab-content" id="v-pills-tabContent">
        <div class="tab-pane fade show active" id="v-pills-query-A" role="tabpanel"
          aria-labelledby="v-pills-query-A-tab">

          <div class="row mt-5">
            <div class="col-lg-12 text-center">

              <h3>Výsledky dotazu A</h3>
              {% set args=[['cumulative_cases', 'Kumulativní nárůst případů'], ['cumulative_deaths', 'Kumulativní nárůst úmrtí'], ['increase_by_age', 'Denní přírůstek podle věkových skupin'], ['mortality_by_age', 'Smrtnost podle věkových skupin'], ['mortality_by_sex', 'Smrtnost podle pohlaví'], ['external_country', 'Původ nákazy (pro více než 10 případů)']]  %}
              {{ graph_tab(args, tmp) }}

            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="v-pills-query-B" role="tabpanel" aria-labelledby="v-pills-query-B-tab">
          <div class="mt-5">
            <div class="">
              <h3>Výsledky dotazu B</h3>
              <div id="slider-map"></div>
              
              <ul class="nav nav-pills mt-3" id="pills-tab-2" role="tablist">
                <li class="nav-item">
                  <a class="nav-link active" id="pills-b1-tab-2" data-toggle="pill" href="#pills-b1" role="tab" aria-controls="pills-b1" aria-selected="true">Mapa</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" id="pills-b2-tab-2" data-toggle="pill" href="#pills-b2" role="tab" aria-controls="pills-b2" aria-selected="false">aaa</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" id="pills-b3-tab-2" data-toggle="pill" href="#pills-b3" role="tab" aria-controls="pills-b3" aria-selected="false">bbb</a>
                </li>
              </ul>

              <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="pills-b1" role="tabpanel" aria-labelledby="pills-b1-tab-2">
                  <div style="width: 100vh; position: absolute; left: 25vh;">
                    {{ map_data|safe }}
                  </div>
                  <div id="tooltip" display="none" style="position: absolute; display: none;"></div>
                </div>
                <div class="tab-pane fade" id="pills-b2" role="tabpanel" aria-labelledby="pills-b2-tab-2">
                  <div class="text-center">
                    {% for n in range(months[0], months[1] + 1) %}
                      {% if loop.index == 1 %}
                      <img class="rep-num" id="rep-num-{{n}}" src="/static/township_averages_rep_num_x_{{n}}.png?{{ range(1, 100000) | random }}">
                      {% else %}
                      <img class="rep-num" id="rep-num-{{n}}" style="display: none;" src="/static/township_averages_rep_num_x_{{n}}.png?{{ range(1, 100000) | random }}">
                      {% endif %}
                    {% endfor %}                    
                  </div>
                </div>
                <div class="tab-pane fade" id="pills-b3" role="tabpanel" aria-labelledby="pills-b3-tab-2">
                  <div class="text-center">
                    {% for n in range(months[0], months[1] + 1) %}
                      {% if loop.index == 1 %}
                      <img class="avg-sort" id="avg-sort-{{n}}" src="/static/township_averages_sorted_x_{{n}}.png?{{ range(1, 100000) | random }}">
                      {% else %}
                      <img class="avg-sort" id="avg-sort-{{n}}" style="display: none;" src="/static/township_averages_sorted_x_{{n}}.png?{{ range(1, 100000) | random }}">
                      {% endif %}
                    {% endfor %} 
                  </div>
                </div>
              </div>
              
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="v-pills-query-C" role="tabpanel" aria-labelledby="v-pills-query-C-tab">
          <div class="row mt-5">
            <div class="col-lg-12 text-center">
              <h3>Výsledky vlastního dotazu</h3>
              {% if tmp %}
                {% set tmp = 'tmp_' %}
              {% else %}
                {% set tmp = '' %}
              {% endif %}

              <div class="text-center">
                <img src="/static/{{ tmp }}custom_query.png?{{ range(1, 100000) | random }}">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap core JavaScript row col-lg-12 text-left position: relative; left: -200px;
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>-->

  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
    crossorigin="anonymous"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='js/nouislider.js') }}"></script>

  <script type="text/javascript">
    const months = ['', 'Leden', 'Únor', 'Březen', 'Duben', 'Květen', 'Červen', 'Červenec', 'Srpen', 'Září', 'Říjen', 'Listopad', 'Prosinec']
    
    function dateToIsoFormat(date) {
      year = date.getFullYear();
      month = date.getMonth()+1;
      dt = date.getDate();

      if (dt < 10) {
        dt = '0' + dt;
      }
      if (month < 10) {
        month = '0' + month;
      }

      return year+'-' + month + '-'+dt;
    }

    function filterDateRange() {
      $('#filter-button').prop('disabled', true);

      var slider = document.getElementById('slider-snap');
      const values = slider.noUiSlider.get();

      const fromMonth = months.indexOf(values[0]);
      const toMonth = months.indexOf(values[1]);

      const now = new Date(Date.now());
      const lastDay = new Date(new Date(now.getFullYear(), toMonth, 1) - 1).getDate();

      const from = dateToIsoFormat(new Date(now.getFullYear(), fromMonth - 1, 1, 0, 0, 0));
      const to = dateToIsoFormat(new Date(now.getFullYear(), toMonth - 1, lastDay, 0, 0, 0));

      window.location = `/?from=${from}&to=${to}`;
    }

    function erase() {
      $('#erase-button').prop('disabled', true);

      if (confirm("Použitím této akce dojde k vymazání všech dat. Opravdu chcete pokračovat?")) {
        window.location.replace('/erase')
      } 
      else {
        $('#erase-button').prop('disabled', false);
      }
    }

    $(document).ready(function() {
      $('#map-{{months[0]}}').show();

      var snapSlider = document.getElementById('slider-snap');
      var mapSlider = document.getElementById('slider-map');

      const firstMonth = {{months[0]|safe}};
      const secondMonth = {{months[1]|safe}};

      noUiSlider.create(snapSlider, {
          start: [firstMonth, secondMonth],
          snap: true,
          connect: true,
          format: {
              to: function (value) {
                  return months[value];
              },
              from: function (value) {
                  return value;
              }
          },
          tooltips: [true, true],
          range: {
              'min': 1,
              '8%':  2,
              '17%': 3,
              '25%': 4,
              '37%': 5,
              '50%': 6,
              '57%': 7,
              '65%': 8,
              '73%': 9,
              '81%': 10,
              '89%': 11,
              'max': 12
          }
      });

      if (firstMonth != secondMonth) {
        const parts = secondMonth - firstMonth;
        const step = 100.0/parts;
        
        range = {
          'min': firstMonth,
          'max': secondMonth
        }

        for (let i = 1; i < parts; i++) {
          const index = `${parseInt(Math.round(i * step))}%`
          range[index] = firstMonth + i;
        }

        noUiSlider.create(mapSlider, {
            start: [firstMonth],
            snap: true,
            connect: 'lower',
            format: {
                to: function (value) {
                    return months[value];
                },
                from: function (value) {
                    return value;
                }
            },
            tooltips: [true],
            range: range
        });

        mapSlider.noUiSlider.on('update', function (values, handle) {
          const index = months.indexOf(values[0]);

          $('svg:visible').hide();
          $(`#map-${index}`).show();

          $('.avg-sort:visible').hide();
          $('.rep-num:visible').hide();

          $(`#avg-sort-${index}`).show();
          $(`#rep-num-${index}`).show();
        });
      }
      else {
        $('#slider-map').text(months[firstMonth]);
      }

      snapSlider.noUiSlider.on('update', function (values, handle) {
        
      });

      $('#pills-tab-2 a[data-toggle="pill"]').on('shown.bs.tab', function (e) {
        const target = $(e.target).attr("href"); // activated tab
   
        var mapSlider = document.getElementById('slider-map');
        const index = months.indexOf(mapSlider.noUiSlider.get());
        const id = parseInt(target.slice(target.length - 1));

        console.log(id)

        switch (id) {
          case 1:
            $('svg').hide();
            $(`#map-${index}`).show();
            break;

          case 2:
            $('.rep-num').hide();
            $(`#rep-num-${index}`).show();
            break;

          case 3:
            $('.avg-sort').hide();
            $(`#avg-sort-${index}`).show();
            break;

          default:
            return;
        }
      });
    });

    function showTooltip(evt, text) {
      let tooltip = document.getElementById("tooltip");
      tooltip.innerHTML = text;
      tooltip.style.display = "block";
      tooltip.style.left = evt.pageX + 10 + 'px';
      tooltip.style.top = evt.pageY + 10 + 'px';
    }

    function hideTooltip() {
      var tooltip = document.getElementById("tooltip");
      tooltip.style.display = "none";
    }
  </script>
</body>

</html>